<div class="header-container">

  <div class="seguimiento-info">
    <div class="info-container">
      <div class="info-item">
        <span class="info-label">Nombre:</span>
        <span class="info-value">{{seguimientoSeleccionado.codigo}} - {{seguimientoSeleccionado.nombre}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Plantas:</span>
        <span class="info-value">
          <span *ngFor="let planta of seguimientoSeleccionado.plantasAsociadas; let last = last">
            {{planta.nombrePlanta}}{{!last ? ', ' : ''}}
          </span>
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">Fecha:</span>
        <span class="info-value">{{seguimientoSeleccionado.fechaInicio | date:'dd/MM/yyyy'}} - {{seguimientoSeleccionado.fechaFin | date:'dd/MM/yyyy'}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Estado:</span>
        <span class="info-value">{{seguimientoSeleccionado.estadoSeguimientoPlanta}}</span>
      </div>
    </div>
  </div>

  <!-- Encabezado Principal -->
  <div class="header-content">
    <div class="title-section">
      <h1 class="page-title">Evaluación Gerentes de Zona</h1>
    </div>

        <div class="action-section">
        <button class="btn add-btn" (click)="showModal()">
          <i class="pi pi-user-plus"></i>
          Agregar
        </button>
        </div>

    </div>
  </div>

  <div class="table-container">
    <p-table 
      [value]="listaEvaluaciones" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="10"
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[10,25,50]"
      styleClass="p-datatable-sm p-datatable-striped"
      [loading]="loading"
      [sortMode]="'multiple'"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} Evaluaciones">
  
      <!-- Header de la tabla -->
      <ng-template pTemplate="header">
        <tr>
          <th colspan="15" class="table-header">
            <ion-icon name="people-outline" class="header-icon"></ion-icon>
            LISTADO DE EVALUACIONES
          </th>
        </tr>
        <tr>
          <th pSortableColumn="fechaRegistro">
            Fecha
          </th>
          <th pSortableColumn="gerenteZonaNombre">
            Gerente Zona
            <p-sortIcon field="gerenteZonaNombre"></p-sortIcon>
            <p-columnFilter type="text" field="gerenteZonaNombre" display="menu"></p-columnFilter>
          </th>
          <th>
            Zona
          </th>
          <th>
            <span pTooltip="Comercial Pto / Prospectación" tooltipPosition="top">1</span>
          </th>
          <th>
            <span pTooltip="Act Mercadeo / Promoción" tooltipPosition="top">2</span>
          </th>
          <th>
            <span pTooltip="Conocimiento Merc / Comp" tooltipPosition="top">3</span>
          </th>
          <th>
            <span pTooltip="Servicio Técnico" tooltipPosition="top">4</span>
          </th>
          <th>
            <span pTooltip="Uso Herramientas Italcol" tooltipPosition="top">5</span>
          </th>
          <th>
            <span pTooltip="Nivel Formación" tooltipPosition="top">6</span>
          </th>
          <th>
            <span pTooltip="Nivel Relacionamiento Cliente" tooltipPosition="top">7</span>
          </th>
          <th>
            <span pTooltip="Actitud General" tooltipPosition="top">8</span>
          </th>
          <th>
            Nota
          </th>
          <th pSortableColumn="observaciones" style="width: 200px;">
            Observaciones
          </th>

          <th>Acciones</th>
        </tr>
      </ng-template>
  
      <!-- Cuerpo de la tabla -->
      <ng-template pTemplate="body" let-evaluacion>
        <tr>
          <td>{{evaluacion.fechaRegistro | date:'dd/MM/yyyy'}}</td>
          <td>{{evaluacion.gerenteZonaNombre}}</td>
          <td>{{evaluacion.nombreZona}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[0]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[1]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[2]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[3]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[4]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[5]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[6]?.respuestaListaNombre)}}</td>
          <td>{{getAbreviacion(evaluacion.respuestas?.[7]?.respuestaListaNombre)}}</td>
          <td>{{getEvaluacionPercentage(evaluacion.respuestas)}}%</td>
          <td>{{evaluacion.observaciones | slice:0:50}}{{evaluacion.observaciones.length > 50 ? '...' : ''}}</td>
          <td class="actions-cell">
            <button pButton 
                    type="button" 
                    icon="pi pi-pencil" 
                    pTooltip="Editar"
                    tooltipPosition="top"
                    class="p-button-rounded p-button-primary p-button-sm"
                    style="margin-right: 0.5rem;"
                    (click)="abrirEvaluacion(evaluacion)">
            </button>            
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  
  <p-dialog [(visible)]="displayModal" 
             [modal]="true" 
             [responsive]="true" 
             [header]="(edit ? 'Actualizar Evaluación' : 'Registrar Evaluación')"
             [style]="{width: '90%', maxWidth: '900px'}">
             <ng-template pTemplate="header">
              <div class="dialog-header">
                <i class="pi pi-list-check"></i>
                <span>{{edit ? 'Actualizar Evaluación' : 'Registrar Evaluación'}}</span>
              </div>
            </ng-template>

            <form [formGroup]="EvaluacionForm">
              <ion-grid>
                <ion-row class="form-row">
                  <ion-col size="12" size-md="6" style="margin-bottom: 1rem;">
                    <span class="p-float-label">
                      <p-dropdown 
                      formControlName="idGerenteZonaTabla" 
                      [options]="listaGerenteZona" 
                      optionLabel="nombreCompleto" 
                      optionValue="id"
                      placeholder="Seleccione un Gerente Zona"
                      [style]="{'width':'90%'}">
                      </p-dropdown>
                      <label>Gerente Zona</label>
                    </span>
                  </ion-col>
                  <!-- <ion-col size="12" size-md="6">
                    <span class="p-float-label">
                      <p-calendar formControlName="fechaRegistro" 
                      [showOnFocus]="false"
                      [disabled]="true"
                      [readonlyInput]="true">
                    </p-calendar>
                      <label>Fecha Registro</label>
                    </span>
                  </ion-col> -->
                </ion-row>

                <ion-row class="form-row">
                  <div class="evaluation-table">
                    <p-table [value]="evaluacionesData" styleClass="p-datatable evaluation-grid">
                      <ng-template pTemplate="header">
                        <tr>
                          <th class="aspecto-header" style="width: 300px;">ASPECTO</th>
                          <th *ngFor="let resp of listaRespuestas" class="respuesta-header">{{resp.nombre}}</th>
                          <th class="total-header">TOTAL</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-aspecto>
                        <tr>
                          <td class="aspecto-cell">{{aspecto.nombre}}</td>
                          <td *ngFor="let resp of listaRespuestas" class="respuesta-cell">
                            <p-radioButton 
                              [name]="'respuesta_' + aspecto.id"
                              [value]="resp.id"
                              [(ngModel)]="aspecto.respuesta"
                              [ngModelOptions]="{standalone: true}">
                            </p-radioButton>
                          </td>
                          <td class="total-cell">{{aspecto.respuesta ? getPercentageForResponse(aspecto.respuesta) : '0,0%'}}</td>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="footer">
                        <tr class="totals-row">
                          <td class="aspecto-cell">TOTAL</td>
                          <td *ngFor="let resp of listaRespuestas" class="respuesta-cell">
                            {{getTotalForResponse(resp.id)}}
                          </td>
                          <td class="total-cell">{{getTotalPercentage()}}%</td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </ion-row>

                <ion-row class="form-row">
                  <ion-col size="12" style="margin-top: 15px;">
                    <span class="p-float-label">
                      <textarea pInputTextarea formControlName="observaciones" rows="1" maxlength="200"></textarea>
                      <label>Observaciones</label>
                    </span>
                  </ion-col>
                </ion-row>

              <!-- Botones -->
              <ion-row class="button-row">
                <ion-col>
                  <div class="button-container">
                    <button pButton 
                            type="submit" 
                            [label]="edit ? 'Actualizar' : 'Guardar'"
                            class="p-button-primary action-button"
                            [disabled]="!EvaluacionForm.valid"
                            (click)="edit ? actualizarEvaluacion() : RegistrarEvaluacion()">
                    </button>
                    <button pButton 
                            type="button" 
                            label="Cancelar" 
                            class="p-button-secondary action-button" 
                            (click)="closeModal()">
                    </button>
                  </div>
                </ion-col>
              </ion-row>
              </ion-grid>
            </form>
    </p-dialog>

    <!-- Confirm Dialog -->
    <p-confirmDialog 
    header="Confirmación" 
    icon="pi pi-exclamation-triangle"
    acceptLabel="Sí"
    rejectLabel="No">
    </p-confirmDialog>
